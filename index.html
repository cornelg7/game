<!doctype html>
<html>
  <head>
    <title>game</title>
  </head>
  <body>
    <script src="js/three.js"></script>
    <script src="js/ControlAndMovement.js"></script>
    <script src="js/FirstLoad.js"></script>
    <script src="js/ForDeath.js"></script>
    <script src="js/ForInit.js"></script>
    <script src="js/Utilities.js"></script>
    <script>
        // essential
      var camera, scene, renderer;
      var time;
      var controlsActive = false;
      var inGame = false;
      var toDispose = [];

        // for levels
      var numberOfLevels = 4;
      var jsonLevels = []; // jsons
      var currentLevel; // json
      var terrainGroup;

        // player
      var player;
      var playerGeometry;
      var playerMaterial;
      // for movement
      var playerXSpeed = 0.03;
      var playerYSpeed = 0.03;
      var playerXAcc = 0.0;
      var playerYAcc = 0.0;
      var eps = 0.001;
      // for falling
      var playerIsFalling = false;
      var playerZSpeed = 1.0;
      var playerZInitial = 2.5;
      var playerZAcc = 0.1;

        // textures
      var texturesMap = {};




        // loads everything, creates world and calls init(0)
      firstInit();


        // initialize level (level)
      function init(level) {
        currentLevel = jsonLevels[level];
        buildLevel(currentLevel); // build current level

        updatePlayer(); // player
        updateCamera(); // place camera behind player

        controlsActive = true; // allow controls
        inGame = true;
      }

      function animate() {
          // checking for player's death
        if (inGame) {
          var playerGridX = coordToGrid(player.position.x);
          var playerGridY = coordToGrid(player.position.y);
          if (gridOutOfBounds(playerGridX, playerGridY) || currentLevel.map[playerGridX][playerGridY] == 0) {
           // console.log("player is falling.");
            playerIsFalling = true;
            controlsActive = false;
            keyMap = {};
          }
          if (playerIsFalling) {
            playerZSpeed = playerZSpeed + playerZAcc;
            player.position.z = player.position.z - Math.log10(playerZSpeed);
           // console.log("acc: " + playerZAcc + "pos: " + player.position.z);
            if (player.position.z < -20) {
              console.log("///////// Player died. Restarting game..")
              inGame = false;
              reInit(0);
            }
          }
            // for smooth movement
          playerOverdueMovements();
        }

          // always look in front of player
        var toLookAt = new THREE.Vector3(10.0, 0.0, 0.0);
        toLookAt.add(player.position);
        camera.lookAt( toLookAt );

        // every 3s or so
        // if (time.getElapsedTime() > 3) {
        //   time = new THREE.Clock(true);
        //   time.start();
        // }

          // essential
        requestAnimationFrame( animate );
        renderer.render( scene, camera );
      }

    </script>
  </body>
</html>
