<!doctype html>
<html>
  <head>
    <title>game</title>
  </head>
  <body>
    <script src="js/three.js"></script>
    <script src="js/Utilities.js"></script>
    <script src="js/LevelSpecifics.js"></script>
    <script src="js/ControlAndMovement.js"></script>
    <script src="js/FirstLoad.js"></script>
    <script src="js/ForDeath.js"></script>
    <script src="js/ForInit.js"></script>
    <script>
        // essential
      var camera, scene, renderer;
      var time;
      var controlsActive = false;
      var inGame = false;
      var toDispose = [];
      var everythingLoaded;

        // for levels
      var numberOfLevels = 3;
      var jsonLevels = []; // jsons
      var currentLevel; // json
      var terrainGroup;
      // for level0
      var levelNumberGroups = [];
      var nextLevelNumber = 0;
      var levelTransp = [];

        // camera
      var smoothRotate = false;
      var rotateCamera = 0;
      var cameraRotateSpeed = 0.01;
      var cameraRotateAcc = 0.0;
      var canRotate = true;

        // player
      var player;
      var playerGeometry;
      var playerMaterial;
      var playerToggleDress;
      // for movement
      var playerXSpeed = 0.03;
      var playerYSpeed = 0.03;
      var playerXAcc = 0.0;
      var playerYAcc = 0.0;
      var playerWeight = 1.1; // 0 -> inf: light -> heavy
      var eps = 0.001;
      // for falling
      var playerGridForgiveness = 1;
      var playerIsFalling = false;
      var playerZSpeed = 1.0;
      var playerZInitial = 2.5;
      var playerZAcc = 0.1;

        // for lights
      var aboveLight;
      var lightDistanceFromPlayer = 10;
      var lightIntensity = 50;
      var lightColor;
      var specularLight = 0x111111;
      var level0NumberGroupLights = [];
      // for bg
      var skyBox;

        // textures
      var texturesMap = {}; // pairs (name, texture)
      var texturesLoaded = false;




        // loads everything, creates world and calls init(0)
      firstInit();


        // initialize level (level)
      function init(level) {
        nextLevelNumber = 0;
        currentLevel = jsonLevels[level];
        levelSpecificsInit(level);
        buildLevel(currentLevel); // build current level

        updatePlayer(); // player
        updateCamera(); // place camera behind player
        setupLight(); // place light above player

        controlsActive = true; // allow controls
        inGame = true;
      }

      function animate() {
          // checking for player's death
        if (inGame) {
          var playerGridX = coordToGrid(player.position.x);
          var playerGridY = coordToGrid(player.position.y);
          if (playerShouldFall(playerGridX, playerGridY) && noLandCloseToPlayer(playerGridForgiveness)) {
           // console.log("player is falling.");
            playerIsFalling = true;
            controlsActive = false;
            keyMap = {};
            if (currentLevel.id == 0) {
              if (playerGridX == levelTransp[1].x && playerGridY == levelTransp[1].y) {
                nextLevelNumber = 1;
              }
              else if (playerGridX == levelTransp[2].x && playerGridY == levelTransp[2].y) {
                nextLevelNumber = 2;
              }
            } 
          }
          if (playerIsFalling) {
            cameraLookPlayer();
            playerZSpeed = playerZSpeed + playerZAcc;
            player.position.z = player.position.z - Math.log10(playerZSpeed);
           // console.log("acc: " + playerZAcc + "pos: " + player.position.z);
            if (player.position.z < -20) {
              console.log("///////// Player died. Restarting game..")
              inGame = false;
              if (everythingLoaded || nextLevelNumber == 0)
                reInit(nextLevelNumber);
              else {
                console.log("Level not loaded yet");
                reInit(0);
              }
            }
          }
            // for smooth movement player + camera
          overdueMovements();

          updateLight();
        }
        // every 3s or so
        // if (time.getElapsedTime() > 3) {
        //   time = new THREE.Clock(true);
        //   time.start();
        // }

          // essential
        requestAnimationFrame( animate );
        renderer.render( scene, camera );
      }

    </script>
  </body>
</html>
